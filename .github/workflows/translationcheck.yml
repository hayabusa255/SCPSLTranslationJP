name: Translation Checker

on:
  workflow_dispatch:

jobs:
  check-translations:
    runs-on: windows-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run translation checker
        id: check
        # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ä½œæ¥­å ´æ‰€ã‚’translationcheckerãƒ•ã‚©ãƒ«ãƒ€ã«æŒ‡å®š
        working-directory: ./translationchecker
        run: |
          $env:PYTHONIOENCODING="utf-8"
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          # working-directoryã‚’æŒ‡å®šã—ãŸã®ã§ã€ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã™ã‚Œã°OK
          ./translationchecker.exe | Out-File -FilePath report.md -Encoding UTF8
          $report = Get-Content report.md -Raw -Encoding UTF8
          $report = $report -replace '`', '\`'
          $report = $report -replace '"', '\"'
          # Convert to base64 to handle special characters
          $bytes = [System.Text.Encoding]::UTF8.GetBytes($report)
          $encoded = [Convert]::ToBase64String($bytes)
          echo "report_encoded=$encoded" >> $env:GITHUB_OUTPUT
        shell: powershell
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ${{ steps.check.outputs.report }}
            
            ---
            *ğŸ¤– Auto-generated by Translation Checker*

      - name: Create issue on push to main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "Translation Status Report - ${{ github.sha }}"
          # report.mdã¯translationcheckerãƒ•ã‚©ãƒ«ãƒ€å†…ã«ä½œæˆã•ã‚Œã‚‹ãŸã‚ã€ãƒ‘ã‚¹ã‚’ä¿®æ­£
          content-filepath: ./translationchecker/report.md
          labels: translation, automated
