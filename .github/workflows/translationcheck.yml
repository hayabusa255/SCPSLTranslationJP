name: Translation Checker

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: 
      - main
  workflow_dispatch:

jobs:
  check-translations:
    runs-on: windows-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download translation checker
        run: |
          $latestRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/${{ github.repository }}/releases/latest"
          $downloadUrl = $latestRelease.assets | Where-Object { $_.name -eq "translationchecker.exe" } | Select-Object -ExpandProperty browser_download_url
          if ($downloadUrl) {
            Write-Host "Downloading from: $downloadUrl"
            Invoke-WebRequest -Uri $downloadUrl -OutFile "translationchecker.exe"
          } else {
            Write-Error "translationchecker.exe not found in latest release"
            exit 1
          }
        shell: powershell

      - name: Run translation checker
        id: check
        run: |
          $env:PYTHONIOENCODING="utf-8"
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          ./translationchecker.exe | Out-File -FilePath report.md -Encoding UTF8
          $report = Get-Content report.md -Raw -Encoding UTF8
          $report = $report -replace '`', '\`'
          $report = $report -replace '"', '\"'
          # Convert to base64 to handle special characters
          $bytes = [System.Text.Encoding]::UTF8.GetBytes($report)
          $encoded = [Convert]::ToBase64String($bytes)
          echo "report_encoded=$encoded" >> $env:GITHUB_OUTPUT
        shell: powershell
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ${{ steps.check.outputs.report }}
            
            ---
            *ðŸ¤– Auto-generated by Translation Checker*

      - name: Create issue on push to main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "Translation Status Report - ${{ github.sha }}"
          content-filepath: report.md
          labels: translation, automated
