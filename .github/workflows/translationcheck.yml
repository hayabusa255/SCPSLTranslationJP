name: Translation Checker

on:
  workflow_dispatch:

    inputs:
      run_ai_check:
        description: 'Enable time-consuming AI nuance check?'
        required: true
        type: boolean
        default: false 

jobs:
  check-translations:
    runs-on: windows-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run translation checker
        id: check
        working-directory: ./translationchecker
        run: |
          $env:PYTHONIOENCODING="utf-8"
          [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
          ./translationchecker.exe | Out-File -FilePath report.md -Encoding UTF8
          $report = Get-Content report.md -Raw -Encoding UTF8
          $escaped_report = $report -replace '%', '%25' -replace "`n", '%0A' -replace "`r", '%0D'
          echo "report=$escaped_report" >> $env:GITHUB_OUTPUT
        shell: powershell
        env:
          GEMINI_API_KEY: ${{ github.event.inputs.run_ai_check == true && secrets.GEMINI_API_KEY || '' }}

      - name: Create issue on push to main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "Translation Status Report - ${{ github.sha }}"
          content-filepath: ./translationchecker/report.md
          labels: translation, automated
